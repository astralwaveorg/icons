name: Auto deploy project to Remote Server
run-name: ${{ github.actor }} æäº¤è§¦å‘è‡ªåŠ¨éƒ¨ç½² ğŸš€

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç åˆ° Actions è¿è¡Œå™¨
            - name: Checkout code
              uses: actions/checkout@v4

            # ç¬¬äºŒæ­¥ï¼šè®¾ç½® SSH å¯†é’¥ç”¨äºåç»­æ“ä½œ
            - name: Set up SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -t rsa -p "${{ secrets.SSH_PORT || 22 }}" "${{ secrets.HOST }}" >> ~/.ssh/known_hosts

            # ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ SSH åœ¨è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œ git å¼ºåˆ¶æ›´æ–°
            - name: Force update and deploy
              run: |
                  echo "å¼€å§‹éƒ¨ç½²..."
                  ssh -o StrictHostKeyChecking=no \
                      -i ~/.ssh/id_rsa \
                      -p "${{ secrets.SSH_PORT || 22 }}" \
                      root@"${{ secrets.HOST }}" \
                      "cd /vol1/1000/Share/hfs/icons && \
                       git fetch --all && \
                       git reset --hard origin/main && \
                       git clean -fd && \
                       git pull origin main"
                  echo "éƒ¨ç½² sha: $SHA"
                  echo "éƒ¨ç½²å®Œæˆ - ä»£ç å·²å¼ºåˆ¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
              env:
                  SHA: ${{ github.sha }}

